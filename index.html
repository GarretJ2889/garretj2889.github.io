<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive D&D 5e Character Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Mate:ital@0;1&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A reorganized dashboard layout. The top section now highlights Character Details and Hit Points for immediate visibility and is collapsible. The main content is split into a three-column grid. Column 1 groups core stats (Abilities, Saving Throws) and now has a collapsible Skills section. Column 2 contains combat essentials (AC, Initiative, Speed) followed by a new Conditions section, Actions, and a button to open the spellbook modal. Column 3 holds descriptive and utility sections (Proficiencies, Inventory, Notes, Backstory, Save/Load), all of which are now collapsible. The spells section is now a pop-out modal to improve page clarity. This new structure provides a more intuitive flow, starting with key identity and vitals, then grouping related mechanics and finally, utility and descriptive information. -->
    <!-- Visualization & Content Choices: The source report (a guide for a spreadsheet) is translated into an interactive form. Goal: Inform/Organize -> Presentation: HTML forms with inputs and labels. Interaction: Direct user input in text/number fields and checkboxes triggers real-time calculations via vanilla JavaScript. The application now supports expertise, which doubles the proficiency bonus, further enhancing its utility. The new Actions section allows users to add and manage custom attacks, with the "To Hit" bonus calculated dynamically based on a selected ability score and a proficiency checkbox. A new Notes section has been added for general character information. A new Inventory section with currency and attunement fields has been added. The actions section now also includes a dropdown to specify the action type (Action, Bonus Action, Reaction). A new Backstory section has been added for narrative text. A new button and dynamic fields have been added to the Skills section to allow for homebrew skills. All new fields are included in the JSON save/load process. A new Conditions section has been added with a dropdown for standard D&D conditions and a description field that updates automatically. The Spells section has been streamlined to a single "Prepared Spells" view with manual entry fields and a new Spell Slot tracker. Finally, a Save & Load section has been implemented, offering a one-way PDF export and a robust, two-way JSON export/import for true data persistence. Disadvantage checkboxes have been added to all skills. All combat stats (AC, Initiative, Speed) are now editable. The attunement limit is now an editable field, allowing for a dynamic maximum count. A dark mode toggle has been added to the top-right corner of the page. The Class and Level fields are now separate, with the Proficiency Bonus automatically calculated based on the character level. The spell list has been removed in favor of manual entry. The spell slots section now automatically calculates slots based on character level, while still allowing for manual adjustment. All major descriptive/utility sections are now collapsible. Justification: This is the most direct and effective way to create a functional character sheet. It avoids unnecessary complexity from visualization libraries like Chart.js, focusing instead on utility and clarity. The core value is the automatic calculation of modifiers and bonuses, which JS handles perfectly. The addition of JSON import/export provides a practical solution for data persistence that is not feasible with a PDF. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5F4; /* stone-100 */
        }
        h1, h2, h3 {
            font-family: 'Mate', serif;
        }
        .stat-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            height: fit-content;
        }
        .stat-block {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .stat-block:hover {
            background-color: #FAFAF9; /* stone-50 */
        }
        .stat-label {
            font-weight: 500;
            color: #44403C; /* stone-700 */
        }
        .ability-score-input {
            width: 4rem;
            text-align: center;
            border: 1px solid #D6D3D1; /* stone-300 */
            border-radius: 0.375rem;
            padding: 0.25rem;
        }
        .modifier-display {
            font-size: 1.25rem;
            font-weight: 600;
            color: #A855F7; /* purple-500 */
            width: 3rem;
            text-align: center;
        }
        .skill-modifier-display {
            font-weight: 600;
            color: #166534; /* green-800 */
            width: 2.5rem;
            text-align: right;
        }
        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: #A855F7; /* purple-500 */
        }
        .header-input {
            background-color: transparent;
            border: none;
            border-bottom: 2px solid #D6D3D1; /* stone-300 */
            width: 100%;
            padding: 0.25rem 0.1rem;
            font-size: 1rem;
            font-weight: 500;
        }
        .header-input:focus {
            outline: none;
            border-bottom-color: #A855F7; /* purple-500 */
        }
        .combat-stat-box {
            background-color: #FAFAF9; /* stone-50 */
            border: 1px solid #E7E5E4; /* stone-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        .combat-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #262626; /* neutral-800 */
        }
        .combat-stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #78716C; /* stone-500 */
            margin-top: 0.25rem;
        }
        .action-row {
            border-bottom: 1px dashed #D6D3D1;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .action-row:last-child {
            border-bottom: none;
        }
        .currency-input {
            width: 100%;
            text-align: center;
            border: 1px solid #D6D3D1;
            border-radius: 0.375rem;
            padding: 0.25rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .condition-block {
            border-bottom: 1px dashed #D6D3D1;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .tab-button {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab-button.active {
            border-bottom-color: #A855F7;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .modal {
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border-radius: 0.5rem;
        }
        .collapsed-content {
            display: none;
        }
        /* Dark Mode styles */
        body.dark {
            background-color: #1c1917; /* stone-900 */
            color: #d6d3d1; /* stone-300 */
        }
        .dark .stat-card {
            background-color: #292524; /* stone-800 */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.5), 0 2px 4px -2px rgb(0 0 0 / 0.5);
        }
        .dark .stat-block:hover {
            background-color: #44403c; /* stone-700 */
        }
        .dark .stat-label {
            color: #d6d3d1; /* stone-300 */
        }
        .dark .ability-score-input, .dark .header-input, .dark .combat-stat-value, .dark .currency-input, .dark textarea {
            background-color: #44403c; /* stone-700 */
            border-color: #57534e; /* stone-600 */
            color: #f5f5f4; /* stone-100 */
        }
        .dark .header-input:focus {
            border-bottom-color: #c084fc; /* purple-400 */
        }
        .dark .combat-stat-box {
            background-color: #292524; /* stone-800 */
            border-color: #44403c; /* stone-700 */
        }
        .dark .combat-stat-value {
            color: #f5f5f4; /* stone-100 */
        }
        .dark .combat-stat-label {
            color: #a8a29e; /* stone-400 */
        }
        .dark .modifier-display {
            color: #c084fc; /* purple-400 */
        }
        .dark .skill-modifier-display {
            color: #4ade80; /* green-400 */
        }
        .dark .condition-block {
            border-bottom-color: #44403c; /* stone-700 */
        }
        .dark .action-row {
            border-bottom-color: #44403c; /* stone-700 */
        }
        .dark .stat-card.border-stone-200 {
            border-color: #44403c; /* stone-700 */
        }
        .dark .tab-button {
            color: #d6d3d1;
        }
        .dark .tab-button.active {
            border-bottom-color: #c084fc;
        }
        .dark .modal-content {
            background-color: #292524;
            color: #d6d3d1;
        }
        .dark .collapsible-header {
            background-color: #292524;
            color: #d6d3d1;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center relative">
            <h1 class="text-4xl md:text-5xl font-bold text-stone-800 dark:text-stone-100">D&D 5e Character Sheet</h1>
            <p class="text-stone-600 dark:text-stone-400 mt-2">An interactive sheet to manage your character's statistics and abilities.</p>
            <div class="absolute top-0 right-0">
                <button id="theme-toggle" class="bg-stone-200 dark:bg-stone-700 text-stone-800 dark:text-stone-100 rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">
                    <span id="theme-icon">🌙</span>
                </button>
            </div>
        </header>
        
        <!-- TOP SECTION: CHARACTER DETAILS & HP -->
        <div id="character-details" class="stat-card mb-6">
            <div onclick="toggleCollapse('character-details')" class="flex justify-between items-center mb-4 cursor-pointer">
                 <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100">Character Details</h2>
                 <div class="flex items-center gap-4">
                     <div>
                         <label for="characterLevel" class="text-sm font-medium text-stone-500">Level</label>
                         <input type="number" id="characterLevel" class="w-16 header-input text-center" placeholder="1" value="1" min="1" max="20" oninput="updateCharacterSheet()">
                     </div>
                     <span class="text-2xl font-bold text-stone-500 toggle-icon">▲</span>
                 </div>
            </div>
            <div id="character-details-content">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-3">
                        <label for="characterName" class="text-sm font-medium text-stone-500">Character Name</label>
                        <input type="text" id="characterName" class="header-input text-2xl" placeholder="Lancelot">
                    </div>
                    <div>
                        <label for="characterClass" class="text-sm font-medium text-stone-500">Class</label>
                        <input type="text" id="characterClass" class="header-input" placeholder="Paladin">
                    </div>
                    <div>
                        <label for="playerName" class="text-sm font-medium text-stone-500">Player Name</label>
                        <input type="text" id="playerName" class="header-input" placeholder="Arthur">
                    </div>
                    <div>
                        <label for="background" class="text-sm font-medium text-stone-500">Background</label>
                        <input type="text" id="background" class="header-input" placeholder="Noble">
                    </div>
                    <div>
                        <label for="alignment" class="text-sm font-medium text-stone-500">Alignment</label>
                        <input type="text" id="alignment" class="header-input" placeholder="Lawful Good">
                    </div>
                    <div>
                        <label for="experience" class="text-sm font-medium text-stone-500">Experience Points</label>
                        <input type="number" id="experience" class="header-input" placeholder="6500">
                    </div>
                </div>
            </div>
            <div id="hit-points-container" class="stat-card border border-stone-200 p-4 mt-6">
                <label class="text-sm font-medium text-stone-500">Hit Points</label>
                <div class="flex items-center justify-center gap-2 mt-2">
                     <input type="number" id="currentHP" class="w-full text-center text-xl p-2 border border-stone-300 rounded" placeholder="HP">
                     <span class="text-stone-500">/</span>
                     <input type="number" id="maxHP" class="w-full text-center text-xl p-2 border border-stone-300 rounded" placeholder="Max">
                </div>
            </div>
        </div>

        <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- COLUMN 1: CORE STATS -->
            <div class="flex flex-col gap-6">
                <!-- ABILITY SCORES -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 mb-4 text-center">Ability Scores</h2>
                    <div id="ability-scores-container"></div>
                </div>

                <!-- SAVING THROWS -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 mb-4 text-center">Saving Throws</h2>
                    <div id="saving-throws-container"></div>
                </div>

                <!-- SKILLS -->
                <div id="skills-collapsible" class="stat-card">
                    <div onclick="toggleCollapse('skills-collapsible')" class="flex justify-between items-center mb-4 cursor-pointer">
                         <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 text-center">Skills</h2>
                         <span class="text-2xl font-bold text-stone-500 toggle-icon">▲</span>
                    </div>
                    <div id="skills-collapsible-content">
                        <div class="flex justify-between items-center mb-4">
                            <button id="addSkillBtn" class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">+</button>
                        </div>
                        <div id="skills-container"></div>
                        <div id="homebrew-skills-container"></div>
                    </div>
                </div>
            </div>

            <!-- COLUMN 2: COMBAT & ABILITIES -->
            <div class="flex flex-col gap-6">
                <!-- COMBAT STATS (Remaining) -->
                <div class="stat-card">
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="combat-stat-box">
                            <input type="number" id="armorClassDisplay" class="combat-stat-value w-full text-center bg-transparent border-none focus:ring-0" value="10" oninput="updateCharacterSheet()">
                            <div class="combat-stat-label">Armor Class</div>
                        </div>
                        <div class="combat-stat-box">
                            <input type="number" id="initiativeDisplay" class="combat-stat-value w-full text-center bg-transparent border-none focus:ring-0" value="0" oninput="updateCharacterSheet()">
                            <div class="combat-stat-label">Initiative</div>
                        </div>
                        <div class="combat-stat-box">
                            <input type="text" id="speed" class="combat-stat-value w-full text-center bg-transparent border-none focus:ring-0" value="30ft">
                            <div class="combat-stat-label">Speed</div>
                        </div>
                    </div>
                     <div class="grid grid-cols-2 gap-4 mt-4">
                        <div class="stat-card border border-stone-200 p-4">
                            <label class="text-sm font-medium text-stone-500">Hit Dice</label>
                            <input type="text" id="hitDice" class="w-full text-center text-lg p-1 mt-1 border border-stone-300 rounded" placeholder="e.g. 5d10">
                        </div>
                        <div class="stat-card border border-stone-200 p-4">
                            <label class="text-sm font-medium text-stone-500">Proficiency</label>
                            <input type="number" id="proficiencyBonus" class="w-full text-center text-lg p-1 mt-1 border border-stone-300 rounded" value="2" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- CONDITIONS -->
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 text-center">Conditions</h2>
                        <button id="addConditionBtn" class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">+</button>
                    </div>
                    <div id="conditions-container" class="flex flex-col gap-4"></div>
                </div>

                <!-- ACTIONS -->
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 text-center">Actions</h2>
                        <button id="addActionBtn" class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">+</button>
                    </div>
                    <div id="actions-container"></div>
                </div>

                <!-- SPELLS BUTTON -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 mb-4 text-center">Spells</h2>
                    <div class="flex justify-center">
                        <button id="openSpellsModalBtn" class="bg-purple-500 text-white font-bold py-2 px-4 rounded-lg">Open Spellbook</button>
                    </div>
                </div>
                
                <div id="features-collapsible" class="stat-card">
                    <div onclick="toggleCollapse('features-collapsible')" class="flex justify-between items-center mb-4 cursor-pointer">
                        <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 text-center">Features & Traits</h2>
                         <span class="text-2xl font-bold text-stone-500 toggle-icon">▲</span>
                    </div>
                    <div id="features-collapsible-content">
                        <textarea id="features-and-traits" class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="List your racial traits, class features, feats, etc."></textarea>
                    </div>
                </div>

                <div id="proficiencies-collapsible" class="stat-card">
                    <div onclick="toggleCollapse('proficiencies-collapsible')" class="flex justify-between items-center mb-4 cursor-pointer">
                        <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 text-center">Other Proficiencies & Languages</h2>
                        <span class="text-2xl font-bold text-stone-500 toggle-icon">▲</span>
                    </div>
                    <div id="proficiencies-collapsible-content">
                        <textarea id="proficiencies" class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="List your armor, weapon, and tool proficiencies, as well as languages."></textarea>
                    </div>
                </div>
            </div>

            <!-- COLUMN 3: DESCRIPTIVE & UTILITY -->
            <div class="flex flex-col gap-6">

                <!-- INVENTORY & ATTUNEMENT -->
                <div id="inventory-collapsible" class="stat-card">
                    <div onclick="toggleCollapse('inventory-collapsible')" class="flex justify-between items-center mb-4 cursor-pointer">
                        <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 text-center">Inventory & Attunement</h2>
                        <span class="text-2xl font-bold text-stone-500 toggle-icon">▲</span>
                    </div>
                    <div id="inventory-collapsible-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-stone-600 dark:text-stone-400">Attuned Items</h3>
                            <div class="flex items-center gap-2">
                                <span id="attunementCount" class="text-sm font-bold text-stone-500">0/3</span>
                                <button id="addAttunedBtn" class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-md font-bold">+</button>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 mb-4">
                            <label for="maxAttunement" class="text-sm font-medium text-stone-500">Max Attuned Items</label>
                            <input type="number" id="maxAttunement" class="w-16 p-1 border border-stone-300 rounded-md text-sm text-center" value="3" min="0" oninput="updateAttunementCount()">
                        </div>
                        <div id="attunedItems-container" class="mb-4 flex flex-col gap-2"></div>
                        <h3 class="text-xl font-bold text-stone-600 dark:text-stone-400 mb-2">General Items</h3>
                        <div class="grid grid-cols-5 gap-2 mb-4">
                            <div>
                                <label for="cp" class="text-sm font-medium text-stone-500">CP</label>
                                <input type="number" id="cp" class="currency-input" placeholder="0">
                            </div>
                            <div>
                                <label for="sp" class="text-sm font-medium text-stone-500">SP</label>
                                <input type="number" id="sp" class="currency-input" placeholder="0">
                            </div>
                            <div>
                                <label for="ep" class="text-sm font-medium text-stone-500">EP</label>
                                <input type="number" id="ep" class="currency-input" placeholder="0">
                            </div>
                            <div>
                                <label for="gp" class="text-sm font-medium text-stone-500">GP</label>
                                <input type="number" id="gp" class="currency-input" placeholder="0">
                            </div>
                            <div>
                                <label for="pp" class="text-sm font-medium text-stone-500">PP</label>
                                <input type="number" id="pp" class="currency-input" placeholder="0">
                            </div>
                        </div>
                        <textarea id="inventory" class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="List your items here..."></textarea>
                    </div>
                </div>

                <!-- NOTES -->
                <div id="notes-collapsible" class="stat-card">
                    <div onclick="toggleCollapse('notes-collapsible')" class="flex justify-between items-center mb-4 cursor-pointer">
                        <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 text-center">Notes</h2>
                         <span class="text-2xl font-bold text-stone-500 toggle-icon">▲</span>
                    </div>
                    <div id="notes-collapsible-content">
                        <textarea id="notes" class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="Add any important notes, plot points, or reminders here."></textarea>
                    </div>
                </div>

                <!-- BACKSTORY -->
                <div id="backstory-collapsible" class="stat-card">
                    <div onclick="toggleCollapse('backstory-collapsible')" class="flex justify-between items-center mb-4 cursor-pointer">
                        <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 text-center">Backstory</h2>
                         <span class="text-2xl font-bold text-stone-500 toggle-icon">▲</span>
                    </div>
                    <div id="backstory-collapsible-content">
                        <textarea id="backstory" class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="Describe your character's history, motivations, and goals."></textarea>
                    </div>
                </div>
                
                <!-- SAVE & LOAD -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 dark:text-stone-100 mb-4 text-center">Save & Load</h2>
                    <div class="flex flex-col gap-4">
                        <button id="exportPdfBtn" class="w-full bg-purple-500 text-white font-bold py-2 px-4 rounded-lg">Export as PDF</button>
                        <button id="exportJsonBtn" class="w-full bg-stone-700 text-white font-bold py-2 px-4 rounded-lg">Export as JSON</button>
                        <input type="file" id="importJsonInput" class="hidden" accept=".json">
                        <button id="importJsonBtn" class="w-full bg-stone-700 text-white font-bold py-2 px-4 rounded-lg">Import from JSON</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Spells Modal -->
    <div id="spells-modal" class="modal hidden">
        <div class="modal-content stat-card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Spells</h2>
                <button id="closeSpellsModalBtn" class="bg-red-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">&times;</button>
            </div>
            
            <div id="spell-stats-container" class="grid grid-cols-3 gap-2 text-center text-sm mb-4">
                <div class="p-2 border border-stone-200 dark:border-stone-700 rounded-lg">
                    <label class="text-sm font-medium text-stone-500">Ability</label>
                    <select id="spellcastingAbility" class="w-full p-1 text-center bg-transparent border-none" onchange="updateCharacterSheet()">
                        <option value="INT">INT</option>
                        <option value="WIS">WIS</option>
                        <option value="CHA">CHA</option>
                    </select>
                </div>
                <div class="p-2 border border-stone-200 dark:border-stone-700 rounded-lg">
                    <div id="spellSaveDc" class="font-bold text-xl">8</div>
                    <div class="text-stone-500 text-xs">Spell Save DC</div>
                </div>
                <div class="p-2 border border-stone-200 dark:border-stone-700 rounded-lg">
                    <div id="spellAttackBonus" class="font-bold text-xl">+2</div>
                    <div class="text-stone-500 text-xs">Spell Attack Bonus</div>
                </div>
            </div>
            
            <h3 class="text-xl font-bold text-stone-600 dark:text-stone-400 mb-2">Spell Slots</h3>
            <div id="spell-slots-container"></div>

            <div class="flex justify-between items-center my-4">
                <h3 class="text-xl font-bold text-stone-600 dark:text-stone-400">Prepared Spells</h3>
                <button id="addSpellBtn" class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">+</button>
            </div>
            <div id="prepared-spells-container" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <script>
        const abilities = [
            { name: 'Strength', abbr: 'STR' },
            { name: 'Dexterity', abbr: 'DEX' },
            { name: 'Constitution', abbr: 'CON' },
            { name: 'Intelligence', abbr: 'INT' },
            { name: 'Wisdom', abbr: 'WIS' },
            { name: 'Charisma', abbr: 'CHA' },
        ];

        const skills = [
            { name: 'Acrobatics', ability: 'DEX' },
            { name: 'Animal Handling', ability: 'WIS' },
            { name: 'Arcana', ability: 'INT' },
            { name: 'Athletics', ability: 'STR' },
            { name: 'Deception', ability: 'CHA' },
            { name: 'History', ability: 'INT' },
            { name: 'Insight', ability: 'WIS' },
            { name: 'Intimidation', ability: 'CHA' },
            { name: 'Investigation', ability: 'INT' },
            { name: 'Medicine', ability: 'WIS' },
            { name: 'Nature', ability: 'INT' },
            { name: 'Perception', ability: 'WIS' },
            { name: 'Performance', ability: 'CHA' },
            { name: 'Persuasion', ability: 'CHA' },
            { name: 'Religion', ability: 'INT' },
            { name: 'Sleight of Hand', ability: 'DEX' },
            { name: 'Stealth', ability: 'DEX' },
            { name: 'Survival', ability: 'WIS' },
        ];
        
        const conditions = {
            'Blinded': 'You cannot see and automatically fail ability checks that require sight. Attack rolls against you have advantage, and your attack rolls have disadvantage.',
            'Charmed': 'You are charmed. You can\'t attack the charmer or target them with harmful abilities or magical effects. The charmer has advantage on ability checks to interact socially with you.',
            'Deafened': 'You cannot hear and automatically fail any ability checks that require hearing.',
            'Frightened': 'You have disadvantage on ability checks and attack rolls while the source of your fear is within line of sight. You can\'t willingly move closer to the source of your fear.',
            'Grappled': 'Your speed becomes 0, and you cannot benefit from any bonus to your speed. The condition ends if the grappler is incapacitated or if you are removed from the grappler\'s reach.',
            'Incapacitated': 'You can\'t take actions or reactions.',
            'Invisible': 'You are impossible to see without the aid of magic or a special sense. For the purpose of hiding, you are heavily obscured. Attack rolls against you have disadvantage, and your attack rolls have advantage.',
            'Paralyzed': 'You are incapacitated and can\'t move or speak. You automatically fail Strength and Dexterity saving throws. Attack rolls against you have advantage. Any attack that hits you is a critical hit if the attacker is within 5 feet of you.',
            'Petrified': 'You are transformed into a solid inanimate substance. You are incapacitated and can\'t move or speak. You automatically fail Strength and Dexterity saving throws. Attack rolls against you have advantage. You have resistance to all damage. You are immune to poison and disease.',
            'Poisoned': 'You have disadvantage on attack rolls and ability checks.',
            'Prone': 'Your only movement option is to crawl, unless you get up and use half your speed to do so. You have disadvantage on attack rolls. Attack rolls against you have advantage if the attacker is within 5 feet, otherwise they have disadvantage.',
            'Restrained': 'Your speed becomes 0, and you can\'t benefit from any bonus to your speed. You have disadvantage on attack rolls and Dexterity saving throws. Attack rolls against you have advantage.',
            'Stunned': 'You are incapacitated and can\'t move, and can only speak falteringly. You automatically fail Strength and Dexterity saving throws. Attack rolls against you have advantage.',
            'Unconscious': 'You are incapacitated, can\'t move or speak, and are unaware of your surroundings. You drop whatever you are holding and fall prone. You automatically fail Strength and Dexterity saving throws. Attack rolls against you have advantage. Any attack that hits you is a critical hit if the attacker is within 5 feet of you.'
        };
        
        const spellSlotsByLevel = [
            [], // Level 0 (Cantrips)
            [2, 3, 4, 4, 4, 4, 4, 4, 4], // Level 1
            [2, 3, 4, 4, 4, 4, 4, 4, 4], // Level 2
            [2, 4, 4, 4, 4, 4, 4, 4, 4], // Level 3
            [3, 4, 4, 4, 4, 4, 4, 4, 4], // Level 4
            [3, 4, 2, 4, 4, 4, 4, 4, 4], // Level 5
            [3, 4, 3, 4, 4, 4, 4, 4, 4], // Level 6
            [3, 4, 3, 2, 4, 4, 4, 4, 4], // Level 7
            [3, 4, 3, 3, 4, 4, 4, 4, 4], // Level 8
            [3, 4, 3, 3, 2, 4, 4, 4, 4], // Level 9
            [3, 4, 3, 3, 3, 4, 4, 4, 4], // Level 10
            [4, 4, 3, 3, 3, 2, 4, 4, 4], // Level 11
            [4, 4, 3, 3, 3, 2, 4, 4, 4], // Level 12
            [4, 4, 3, 3, 3, 1, 1, 4, 4], // Level 13
            [4, 4, 3, 3, 3, 1, 1, 4, 4], // Level 14
            [4, 4, 3, 3, 3, 2, 1, 4, 4], // Level 15
            [4, 4, 3, 3, 3, 2, 1, 4, 4], // Level 16
            [4, 4, 3, 3, 3, 2, 1, 1, 4], // Level 17
            [4, 4, 3, 3, 3, 2, 1, 1, 4], // Level 18
            [4, 4, 3, 3, 3, 2, 2, 1, 4], // Level 19
            [4, 4, 3, 3, 3, 2, 2, 2, 4], // Level 20
        ];
        
        function createStatBlock(container, id, label) {
            const block = document.createElement('div');
            block.className = 'stat-block';
            block.innerHTML = `
                <label for="${id}" class="stat-label">${label}</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="${id}" class="ability-score-input" value="10" oninput="updateCharacterSheet()">
                    <div id="${id}Mod" class="modifier-display">+0</div>
                </div>
            `;
            container.appendChild(block);
        }

        function createSavingThrowBlock(container, id, label, abilityId) {
            const block = document.createElement('div');
            block.className = 'stat-block';
            block.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="${id}Prof" onchange="updateCharacterSheet()">
                    <label for="${id}Prof" class="stat-label">${label}</label>
                </div>
                <div id="${id}Bonus" class="skill-modifier-display">+0</div>
            `;
            container.appendChild(block);
        }

        function createSkillBlock(container, skill) {
            const id = skill.name.replace(/\s+/g, '');
            const block = document.createElement('div');
            block.className = 'stat-block';
            block.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-stone-500">P</span>
                    <input type="checkbox" id="${id}Prof" onchange="updateCharacterSheet()">
                    <span class="text-sm font-bold text-stone-500 ml-2">E</span>
                    <input type="checkbox" id="${id}Expertise" onchange="updateCharacterSheet()">
                    <span class="text-sm font-bold text-stone-500 ml-2">D</span>
                    <input type="checkbox" id="${id}Disadvantage" onchange="updateCharacterSheet()">
                    <label for="${id}Prof" class="stat-label ml-2">${skill.name} <span class="text-xs text-stone-400">(${skill.ability})</span></label>
                </div>
                <div id="${id}Bonus" class="skill-modifier-display">+0</div>
            `;
            container.appendChild(block);
        }
        
        function createHomebrewSkillBlock(container, data = {}) {
            const skillId = data.id || `homebrew-skill-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const block = document.createElement('div');
            block.className = 'stat-block homebrew-skill';
            block.id = skillId;
            block.innerHTML = `
                <div class="flex items-center gap-2 flex-grow">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-stone-500">P</span>
                        <input type="checkbox" id="${skillId}-prof" onchange="updateCharacterSheet()" ${data.proficient ? 'checked' : ''}>
                        <span class="text-sm font-bold text-stone-500 ml-2">E</span>
                        <input type="checkbox" id="${skillId}-expertise" onchange="updateCharacterSheet()" ${data.expertise ? 'checked' : ''}>
                        <span class="text-sm font-bold text-stone-500 ml-2">D</span>
                        <input type="checkbox" id="${skillId}-disadvantage" onchange="updateCharacterSheet()" ${data.disadvantage ? 'checked' : ''}>
                    </div>
                    <input type="text" id="${skillId}-name" class="w-2/3 p-1 border border-stone-300 rounded-md text-sm" placeholder="Skill Name" value="${data.name || ''}" oninput="updateCharacterSheet()">
                    <select id="${skillId}-ability" class="w-1/3 p-1 border border-stone-300 rounded-md text-sm" onchange="updateCharacterSheet()">
                        ${abilities.map(ability => `<option value="${ability.abbr}" ${data.ability === ability.abbr ? 'selected' : ''}>${ability.abbr}</option>`).join('')}
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <div id="${skillId}-bonus" class="skill-modifier-display">+0</div>
                    <button onclick="document.getElementById('${skillId}').remove(); updateCharacterSheet();" class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">&times;</button>
                </div>
            `;
            container.appendChild(block);
            updateCharacterSheet();
        }

        function createActionBlock(container, data = {}) {
            const actionId = data.id || `action-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const actionRow = document.createElement('div');
            actionRow.className = 'action-row grid grid-cols-1 md:grid-cols-3 gap-4';
            actionRow.id = actionId;
            actionRow.innerHTML = `
                <div class="col-span-1 md:col-span-3">
                    <label for="${actionId}-name" class="text-sm font-medium text-stone-500">Action Name</label>
                    <input type="text" id="${actionId}-name" class="header-input" value="${data.name || ''}" placeholder="e.g., Longsword Attack">
                </div>
                <div class="flex flex-col">
                    <label for="${actionId}-type" class="text-sm font-medium text-stone-500">Type</label>
                    <select id="${actionId}-type" class="w-full p-2 border border-stone-300 rounded-md mb-2" onchange="updateCharacterSheet()">
                        <option value="Action" ${data.type === 'Action' ? 'selected' : ''}>Action</option>
                        <option value="Bonus Action" ${data.type === 'Bonus Action' ? 'selected' : ''}>Bonus Action</option>
                        <option value="Reaction" ${data.type === 'Reaction' ? 'selected' : ''}>Reaction</option>
                    </select>
                    <label for="${actionId}-stat" class="text-sm font-medium text-stone-500">To Hit</label>
                    <div class="flex items-center gap-2">
                         <span class="text-sm font-bold text-stone-500">P</span>
                         <input type="checkbox" id="${actionId}-prof" onchange="updateCharacterSheet()" ${data.proficient ? 'checked' : ''}>
                        <select id="${actionId}-stat" class="w-full p-2 border border-stone-300 rounded-md" onchange="updateCharacterSheet()">
                            ${abilities.map(ability => `<option value="${ability.abbr}" ${data.stat === ability.abbr ? 'selected' : ''}>${ability.abbr}</option>`).join('')}
                        </select>
                        <div id="${actionId}-tohit" class="modifier-display w-12">+0</div>
                    </div>
                </div>
                <div>
                    <label for="${actionId}-damage" class="text-sm font-medium text-stone-500">Damage</label>
                    <input type="text" id="${actionId}-damage" class="w-full p-2 border border-stone-300 rounded-md" value="${data.damage || ''}" placeholder="e.g., 1d8+3 Slashing">
                </div>
                <div class="flex items-center justify-end">
                    <button onclick="document.getElementById('${actionId}').remove(); updateCharacterSheet();" class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold -mt-8">&times;</button>
                </div>
            `;
            container.appendChild(actionRow);
            updateCharacterSheet();
        }

        function createAttunedItemBlock(container, data = '') {
            const maxAttunement = parseInt(document.getElementById('maxAttunement').value) || 0;
            if (container.children.length >= maxAttunement) {
                alert(`You can only have up to ${maxAttunement} attuned items.`);
                return;
            }
            const itemId = `attuned-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const itemRow = document.createElement('div');
            itemRow.className = 'flex items-center gap-2';
            itemRow.id = itemId;
            itemRow.innerHTML = `
                <input type="text" class="w-full p-2 border border-stone-300 rounded-md text-sm" value="${data}" placeholder="Item Name">
                <button onclick="document.getElementById('${itemId}').remove(); updateAttunementCount();" class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">&times;</button>
            `;
            container.appendChild(itemRow);
            updateAttunementCount();
        }
        
        function createConditionBlock(container, data = {}) {
            const conditionId = data.id || `condition-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const block = document.createElement('div');
            block.className = 'condition-block';
            block.id = conditionId;
            block.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <select id="${conditionId}-select" class="w-2/3 p-2 border border-stone-300 rounded-md" onchange="updateConditionDescription('${conditionId}')">
                        <option value="">-- Select a Condition --</option>
                        ${Object.keys(conditions).map(condition => `<option value="${condition}" ${data.name === condition ? 'selected' : ''}>${condition}</option>`).join('')}
                    </select>
                    <button onclick="document.getElementById('${conditionId}').remove();" class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">&times;</button>
                </div>
                <p id="${conditionId}-description" class="text-sm text-stone-600 italic px-2">${data.description || ''}</p>
            `;
            container.appendChild(block);
            if (data.name) {
                updateConditionDescription(conditionId);
            }
        }
        
        function createSpellSlotBlock(container, level, total, used) {
            const block = document.createElement('div');
            block.className = 'flex items-center mb-2';
            block.innerHTML = `
                <div class="font-bold text-sm text-stone-600 dark:text-stone-400 w-16">Lvl ${level}</div>
                <input type="number" id="slots-total-${level}" class="w-12 text-center p-1 border border-stone-300 dark:border-stone-600 rounded-md text-sm" value="${total}" min="0" oninput="updateSpellSlots(${level}, this.value)">
                <span class="mx-2">/</span>
                <div class="flex flex-grow items-center" id="slots-used-${level}"></div>
            `;
            container.appendChild(block);
            const usedSlotsContainer = document.getElementById(`slots-used-${level}`);
            for (let j = 0; j < total; j++) {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'w-4 h-4 ml-1 accent-purple-500';
                if (j < used) {
                    checkbox.checked = true;
                }
                usedSlotsContainer.appendChild(checkbox);
            }
        }

        function createPreparedSpellBlock(container, data = {}) {
            const spellId = data.id || `prepared-spell-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const block = document.createElement('div');
            block.className = 'p-2 border border-stone-300 dark:border-stone-600 rounded-md flex flex-col prepared-spell-block';
            block.id = spellId;
            block.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <input type="text" id="${spellId}-name" class="header-input font-bold text-md flex-grow" placeholder="Spell Name" value="${data.name || ''}">
                    <button onclick="document.getElementById('${spellId}').remove();" class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold ml-2">&times;</button>
                </div>
                <textarea id="${spellId}-description" class="w-full h-20 p-1 border border-stone-300 dark:border-stone-600 rounded-md text-sm" placeholder="Spell Description">${data.description || ''}</textarea>
            `;
            container.appendChild(block);
        }

        function updateActionToHit(actionId, abilityMods, proficiencyBonus) {
            const statSelect = document.getElementById(`${actionId}-stat`);
            const profCheckbox = document.getElementById(`${actionId}-prof`);
            const toHitDisplay = document.getElementById(`${actionId}-tohit`);

            if (statSelect && toHitDisplay) {
                const selectedStat = statSelect.value;
                const statMod = abilityMods[selectedStat] || 0;
                const isProficient = profCheckbox.checked;
                const bonus = statMod + (isProficient ? proficiencyBonus : 0);
                toHitDisplay.textContent = formatBonus(bonus);
            }
        }

        function updateAttunementCount() {
            const count = document.getElementById('attunedItems-container').children.length;
            const maxAttunement = document.getElementById('maxAttunement').value || 3;
            document.getElementById('attunementCount').textContent = `${count}/${maxAttunement}`;
        }
        
        function updateConditionDescription(conditionId) {
            const selectElement = document.getElementById(`${conditionId}-select`);
            const descriptionElement = document.getElementById(`${conditionId}-description`);
            const selectedCondition = selectElement.value;
            
            if (conditions[selectedCondition]) {
                descriptionElement.textContent = conditions[selectedCondition];
            } else {
                descriptionElement.textContent = '';
            }
        }

        function getProficiencyBonus(level) {
            if (level >= 1 && level <= 4) return 2;
            if (level >= 5 && level <= 8) return 3;
            if (level >= 9 && level <= 12) return 4;
            if (level >= 13 && level <= 16) return 5;
            if (level >= 17 && level <= 20) return 6;
            return 2; // Default for invalid levels
        }

        function updateSpellSlots(level = null, total = null) {
            const characterLevel = parseInt(document.getElementById('characterLevel').value) || 1;
            const spellSlots = spellSlotsByLevel[characterLevel - 1] || [];
            
            for (let i = 0; i <= 9; i++) {
                const totalInput = document.getElementById(`slots-total-${i}`);
                if (totalInput) {
                    let newTotal = 0;
                    if (i > 0 && spellSlots[i-1]) {
                        newTotal = spellSlots[i-1];
                    }
                    if (level === i && total !== null) {
                         newTotal = total;
                    }
                    totalInput.value = newTotal;

                    const usedSlotsContainer = document.getElementById(`slots-used-${i}`);
                    if (usedSlotsContainer) {
                        const currentUsed = Array.from(usedSlotsContainer.children).filter(cb => cb.checked).length;
                        usedSlotsContainer.innerHTML = '';
                        for (let j = 0; j < newTotal; j++) {
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.className = 'w-4 h-4 ml-1 accent-purple-500';
                            checkbox.checked = j < currentUsed;
                            usedSlotsContainer.appendChild(checkbox);
                        }
                    }
                }
            }
        }
        
        function toggleCollapse(id) {
            const content = document.getElementById(`${id}-content`);
            const icon = document.querySelector(`#${id} .toggle-icon`);
            content.classList.toggle('hidden');
            icon.textContent = content.classList.contains('hidden') ? '▼' : '▲';
        }

        function showSpellsModal() {
            document.getElementById('spells-modal').classList.remove('hidden');
        }

        function hideSpellsModal() {
            document.getElementById('spells-modal').classList.add('hidden');
        }

        function initializeSheet() {
            const abilityContainer = document.getElementById('ability-scores-container');
            abilities.forEach(ability => createStatBlock(abilityContainer, ability.abbr.toLowerCase(), ability.name));

            const savingThrowsContainer = document.getElementById('saving-throws-container');
            abilities.forEach(ability => createSavingThrowBlock(savingThrowsContainer, ability.abbr.toLowerCase() + 'Save', ability.name, ability.abbr.toLowerCase()));
            
            const skillsContainer = document.getElementById('skills-container');
            skills.forEach(skill => createSkillBlock(skillsContainer, skill));
            
            document.getElementById('addActionBtn').addEventListener('click', () => {
                createActionBlock(document.getElementById('actions-container'));
            });

            document.getElementById('addAttunedBtn').addEventListener('click', () => {
                createAttunedItemBlock(document.getElementById('attunedItems-container'));
            });

            document.getElementById('addSkillBtn').addEventListener('click', () => {
                createHomebrewSkillBlock(document.getElementById('homebrew-skills-container'));
            });
            
            document.getElementById('addConditionBtn').addEventListener('click', () => {
                createConditionBlock(document.getElementById('conditions-container'));
            });
            
            document.getElementById('addSpellBtn').addEventListener('click', () => {
                createPreparedSpellBlock(document.getElementById('prepared-spells-container'));
            });

            document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
            document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
            document.getElementById('importJsonBtn').addEventListener('click', () => {
                document.getElementById('importJsonInput').click();
            });
            document.getElementById('importJsonInput').addEventListener('change', importFromJson);
            
            document.getElementById('openSpellsModalBtn').addEventListener('click', showSpellsModal);
            document.getElementById('closeSpellsModalBtn').addEventListener('click', hideSpellsModal);

            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            for (let i = 0; i <= 9; i++) {
                 createSpellSlotBlock(document.getElementById('spell-slots-container'), i, 0, 0);
            }
            
            // Initial theme check
            if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark');
                document.getElementById('theme-icon').textContent = '☀️';
            }
            
            updateCharacterSheet();
        }
        
        function toggleTheme() {
            document.body.classList.toggle('dark');
            const icon = document.getElementById('theme-icon');
            if (document.body.classList.contains('dark')) {
                localStorage.setItem('theme', 'dark');
                icon.textContent = '☀️';
            } else {
                localStorage.setItem('theme', 'light');
                icon.textContent = '�';
            }
        }


        function getModifier(score) {
            return Math.floor((score - 10) / 2);
        }

        function formatBonus(bonus) {
            return bonus >= 0 ? `+${bonus}` : bonus;
        }

        function updateCharacterSheet() {
            const characterLevel = parseInt(document.getElementById('characterLevel').value) || 1;
            const proficiencyBonus = getProficiencyBonus(characterLevel);
            document.getElementById('proficiencyBonus').value = proficiencyBonus;

            const abilityScores = {};
            const abilityMods = {};

            abilities.forEach(ability => {
                const abbr = ability.abbr.toLowerCase();
                const score = parseInt(document.getElementById(abbr).value) || 10;
                const mod = getModifier(score);
                abilityScores[ability.abbr] = score;
                abilityMods[ability.abbr] = mod;
                document.getElementById(`${abbr}Mod`).textContent = formatBonus(mod);
            });

            abilities.forEach(ability => {
                const abbr = ability.abbr.toLowerCase();
                const isProficient = document.getElementById(`${abbr}SaveProf`).checked;
                const bonus = abilityMods[ability.abbr] + (isProficient ? proficiencyBonus : 0);
                document.getElementById(`${abbr}SaveBonus`).textContent = formatBonus(bonus);
            });

            skills.forEach(skill => {
                const id = skill.name.replace(/\s+/g, '');
                const isExpert = document.getElementById(`${id}Expertise`).checked;
                const isProficient = document.getElementById(`${id}Prof`).checked;
                const isDisadvantage = document.getElementById(`${id}Disadvantage`).checked;
                let bonus = abilityMods[skill.ability] + (isExpert ? proficiencyBonus * 2 : (isProficient ? proficiencyBonus : 0));
                
                // Disadvantage logic (not affecting the modifier directly, but a status to show)
                const bonusDisplay = document.getElementById(`${id}Bonus`);
                if(isDisadvantage){
                    bonusDisplay.style.color = '#B91C1C'; // Red
                } else {
                    bonusDisplay.style.color = '#166534'; // Green
                }
                
                document.getElementById(`${id}Bonus`).textContent = formatBonus(bonus);
            });

            document.querySelectorAll('.homebrew-skill').forEach(skillElement => {
                const id = skillElement.id;
                const ability = document.getElementById(`${id}-ability`).value;
                const isExpert = document.getElementById(`${id}-expertise`).checked;
                const isProficient = document.getElementById(`${id}-prof`).checked;
                const isDisadvantage = document.getElementById(`${id}-disadvantage`).checked;
                let bonus = abilityMods[ability] + (isExpert ? proficiencyBonus * 2 : (isProficient ? proficiencyBonus : 0));

                const bonusDisplay = document.getElementById(`${id}-bonus`);
                 if(isDisadvantage){
                    bonusDisplay.style.color = '#B91C1C'; // Red
                } else {
                    bonusDisplay.style.color = '#166534'; // Green
                }
                document.getElementById(`${id}-bonus`).textContent = formatBonus(bonus);
            });
            
            document.querySelectorAll('.action-row').forEach(row => {
                updateActionToHit(row.id, abilityMods, proficiencyBonus);
            });

            updateAttunementCount();

            // Spells
            const spellAbility = document.getElementById('spellcastingAbility').value;
            const spellMod = abilityMods[spellAbility];
            const spellSaveDc = 8 + proficiencyBonus + spellMod;
            const spellAttackBonus = proficiencyBonus + spellMod;
            
            document.getElementById('spellSaveDc').textContent = spellSaveDc;
            document.getElementById('spellAttackBonus').textContent = formatBonus(spellAttackBonus);
            updateSpellSlots();
        }
        
        async function exportToPdf() {
            const mainContent = document.querySelector('main');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Hide the spells modal and collapse the sections before taking the screenshot
            hideSpellsModal();
            const characterDetailsCollapsed = document.getElementById('character-details-content').classList.contains('hidden');
            const skillsCollapsed = document.getElementById('skills-collapsible-content').classList.contains('hidden');
            if (!characterDetailsCollapsed) toggleCollapse('character-details');
            if (!skillsCollapsed) toggleCollapse('skills-collapsible');

            const canvas = await html2canvas(document.body, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            doc.save('dnd-character-sheet.pdf');

            // Restore the state after saving
            if (!characterDetailsCollapsed) toggleCollapse('character-details');
            if (!skillsCollapsed) toggleCollapse('skills-collapsible');
        }

        function exportToJson() {
            const data = {
                theme: document.body.classList.contains('dark') ? 'dark' : 'light',
                collapsedSections: {
                    characterDetails: document.getElementById('character-details-content').classList.contains('hidden'),
                    skills: document.getElementById('skills-collapsible-content').classList.contains('hidden'),
                    proficiencies: document.getElementById('proficiencies-collapsible-content').classList.contains('hidden'),
                    inventory: document.getElementById('inventory-collapsible-content').classList.contains('hidden'),
                    notes: document.getElementById('notes-collapsible-content').classList.contains('hidden'),
                    backstory: document.getElementById('backstory-collapsible-content').classList.contains('hidden'),
                },
                characterInfo: {
                    characterName: document.getElementById('characterName').value,
                    characterClass: document.getElementById('characterClass').value,
                    characterLevel: document.getElementById('characterLevel').value,
                    background: document.getElementById('background').value,
                    playerName: document.getElementById('playerName').value,
                    race: document.getElementById('race').value,
                    alignment: document.getElementById('alignment').value,
                    experience: document.getElementById('experience').value,
                },
                combatStats: {
                    ac: document.getElementById('armorClassDisplay').value,
                    speed: document.getElementById('speed').value,
                    initiative: document.getElementById('initiativeDisplay').value,
                    currentHP: document.getElementById('currentHP').value,
                    maxHP: document.getElementById('maxHP').value,
                    hitDice: document.getElementById('hitDice').value,
                    proficiencyBonus: document.getElementById('proficiencyBonus').value,
                },
                abilityScores: {},
                savingThrows: {},
                skills: {},
                homebrewSkills: [],
                conditions: [],
                actions: [],
                notes: document.getElementById('notes').value,
                backstory: document.getElementById('backstory').value,
                inventory: document.getElementById('inventory').value,
                proficiencies: document.getElementById('proficiencies').value,
                attunedItems: {
                    maxAttunement: document.getElementById('maxAttunement').value,
                    items: Array.from(document.querySelectorAll('#attunedItems-container input[type="text"]')).map(input => input.value),
                },
                currency: {
                    cp: document.getElementById('cp').value,
                    sp: document.getElementById('sp').value,
                    ep: document.getElementById('ep').value,
                    gp: document.getElementById('gp').value,
                    pp: document.getElementById('pp').value,
                },
                spells: {
                    spellcastingAbility: document.getElementById('spellcastingAbility').value,
                    prepared: Array.from(document.querySelectorAll('#prepared-spells-container .prepared-spell-block')).map(el => {
                        const id = el.id;
                        return {
                            id: id,
                            name: document.getElementById(`${id}-name`).value,
                            description: document.getElementById(`${id}-description`).value,
                        };
                    }),
                    spellSlots: {},
                }
            };
            for (let i = 0; i <= 9; i++) {
                const total = document.getElementById(`slots-total-${i}`).value;
                const used = Array.from(document.querySelectorAll(`#slots-used-${i} input[type="checkbox"]:checked`)).length;
                data.spells.spellSlots[i] = { total: total, used: used };
            }

            abilities.forEach(ability => {
                const abbr = ability.abbr.toLowerCase();
                data.abilityScores[abbr] = parseInt(document.getElementById(abbr).value);
                data.savingThrows[`${abbr}SaveProf`] = document.getElementById(`${abbr}SaveProf`).checked;
            });

            skills.forEach(skill => {
                const id = skill.name.replace(/\s+/g, '');
                data.skills[id] = {
                    proficient: document.getElementById(`${id}Prof`).checked,
                    expertise: document.getElementById(`${id}Expertise`).checked,
                    disadvantage: document.getElementById(`${id}Disadvantage`).checked,
                };
            });
            
            document.querySelectorAll('.homebrew-skill').forEach(skillElement => {
                const id = skillElement.id;
                data.homebrewSkills.push({
                    id: id,
                    name: document.getElementById(`${id}-name`).value,
                    ability: document.getElementById(`${id}-ability`).value,
                    proficient: document.getElementById(`${id}-prof`).checked,
                    expertise: document.getElementById(`${id}-expertise`).checked,
                    disadvantage: document.getElementById(`${id}-disadvantage`).checked,
                });
            });
            
            document.querySelectorAll('.condition-block').forEach(conditionElement => {
                const id = conditionElement.id;
                data.conditions.push({
                    id: id,
                    name: document.getElementById(`${id}-select`).value
                });
            });

            document.querySelectorAll('.action-row').forEach(row => {
                data.actions.push({
                    id: row.id,
                    name: document.getElementById(`${row.id}-name`).value,
                    type: document.getElementById(`${row.id}-type`).value,
                    stat: document.getElementById(`${row.id}-stat`).value,
                    proficient: document.getElementById(`${row.id}-prof`).checked,
                    damage: document.getElementById(`${row.id}-damage`).value,
                });
            });

            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.characterInfo.characterName || 'dnd-character'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.theme === 'dark') {
                        document.body.classList.add('dark');
                        document.getElementById('theme-icon').textContent = '☀️';
                        localStorage.setItem('theme', 'dark');
                    } else {
                        document.body.classList.remove('dark');
                        document.getElementById('theme-icon').textContent = '🌙';
                        localStorage.setItem('theme', 'light');
                    }

                    if (data.collapsedSections) {
                        const sections = ['character-details', 'skills-collapsible', 'proficiencies-collapsible', 'inventory-collapsible', 'notes-collapsible', 'backstory-collapsible'];
                        sections.forEach(id => {
                            const content = document.getElementById(`${id}-content`);
                            const icon = document.querySelector(`#${id} .toggle-icon`);
                            if (data.collapsedSections[id.replace(/-collapsible/, '')]) {
                                content.classList.add('hidden');
                                icon.textContent = '▼';
                            } else {
                                content.classList.remove('hidden');
                                icon.textContent = '▲';
                            }
                        });
                    }


                    document.getElementById('characterName').value = data.characterInfo.characterName;
                    document.getElementById('characterClass').value = data.characterInfo.characterClass;
                    document.getElementById('characterLevel').value = data.characterInfo.characterLevel;
                    document.getElementById('background').value = data.characterInfo.background;
                    document.getElementById('playerName').value = data.characterInfo.playerName;
                    document.getElementById('race').value = data.characterInfo.race;
                    document.getElementById('alignment').value = data.characterInfo.alignment;
                    document.getElementById('experience').value = data.characterInfo.experience;
                    
                    document.getElementById('armorClassDisplay').value = data.combatStats.ac;
                    document.getElementById('speed').value = data.combatStats.speed;
                    document.getElementById('initiativeDisplay').value = data.combatStats.initiative;
                    document.getElementById('currentHP').value = data.combatStats.currentHP;
                    document.getElementById('maxHP').value = data.combatStats.maxHP;
                    document.getElementById('hitDice').value = data.combatStats.hitDice;
                    
                    abilities.forEach(ability => {
                        const abbr = ability.abbr.toLowerCase();
                        document.getElementById(abbr).value = data.abilityScores[abbr] || 10;
                        document.getElementById(`${abbr}SaveProf`).checked = data.savingThrows[`${abbr}SaveProf`] || false;
                    });

                    skills.forEach(skill => {
                        const id = skill.name.replace(/\s+/g, '');
                        if (data.skills[id]) {
                            document.getElementById(`${id}Prof`).checked = data.skills[id].proficient;
                            document.getElementById(`${id}Expertise`).checked = data.skills[id].expertise;
                            document.getElementById(`${id}Disadvantage`).checked = data.skills[id].disadvantage;
                        }
                    });

                    document.getElementById('inventory').value = data.inventory || '';
                    document.getElementById('cp').value = data.currency.cp;
                    document.getElementById('sp').value = data.currency.sp;
                    document.getElementById('ep').value = data.currency.ep;
                    document.getElementById('gp').value = data.currency.gp;
                    document.getElementById('pp').value = data.currency.pp;

                    document.getElementById('notes').value = data.notes;
                    document.getElementById('backstory').value = data.backstory;
                    document.getElementById('proficiencies').value = data.proficiencies;

                    const actionsContainer = document.getElementById('actions-container');
                    actionsContainer.innerHTML = '';
                    if (data.actions && Array.isArray(data.actions)) {
                        data.actions.forEach(actionData => createActionBlock(actionsContainer, actionData));
                    }

                    const attunedItemsContainer = document.getElementById('attunedItems-container');
                    attunedItemsContainer.innerHTML = '';
                    if (data.attunedItems && Array.isArray(data.attunedItems.items)) {
                        document.getElementById('maxAttunement').value = data.attunedItems.maxAttunement;
                        data.attunedItems.items.forEach(item => createAttunedItemBlock(attunedItemsContainer, item));
                    }

                    const homebrewSkillsContainer = document.getElementById('homebrew-skills-container');
                    homebrewSkillsContainer.innerHTML = '';
                    if (data.homebrewSkills && Array.isArray(data.homebrewSkills)) {
                        data.homebrewSkills.forEach(skillData => createHomebrewSkillBlock(homebrewSkillsContainer, skillData));
                    }
                    
                    const conditionsContainer = document.getElementById('conditions-container');
                    conditionsContainer.innerHTML = '';
                    if (data.conditions && Array.isArray(data.conditions)) {
                        data.conditions.forEach(conditionData => createConditionBlock(conditionsContainer, conditionData));
                    }
                    
                    const preparedSpellsContainer = document.getElementById('prepared-spells-container');
                    preparedSpellsContainer.innerHTML = '';
                    if (data.spells && Array.isArray(data.spells.prepared)) {
                        data.spells.prepared.forEach(spellData => createPreparedSpellBlock(preparedSpellsContainer, spellData));
                    }

                    const spellSlotsContainer = document.getElementById('spell-slots-container');
                    if (data.spells && data.spells.spellSlots) {
                         for (let i = 0; i <= 9; i++) {
                             if (data.spells.spellSlots[i]) {
                                 document.getElementById(`slots-total-${i}`).value = data.spells.spellSlots[i].total;
                                 const usedSlotsContainer = document.getElementById(`slots-used-${i}`);
                                 usedSlotsContainer.innerHTML = '';
                                 for (let j = 0; j < data.spells.spellSlots[i].total; j++) {
                                     const checkbox = document.createElement('input');
                                     checkbox.type = 'checkbox';
                                     checkbox.className = 'w-4 h-4 ml-1 accent-purple-500';
                                     checkbox.checked = j < data.spells.spellSlots[i].used;
                                     usedSlotsContainer.appendChild(checkbox);
                                 }
                             }
                         }
                    }
                    
                    document.getElementById('spellcastingAbility').value = data.spells.spellcastingAbility;

                    updateCharacterSheet();
                    alert('Character data imported successfully!');
                } catch (error) {
                    alert('Failed to import file. Please ensure it is a valid JSON file.');
                }
            };
            reader.readAsText(file);
        }

        document.addEventListener('DOMContentLoaded', initializeSheet);
    </script>
</body>
</html>
�

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive D&D 5e Character Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Mate:ital@0;1&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals -->
    <!-- Application Structure Plan: A reorganized dashboard layout. The top section now highlights Character Details and Hit Points for immediate visibility. The main content is split into a three-column grid. Column 1 groups core stats (Abilities, Saving Throws, Skills). Column 2 contains combat essentials (AC, Initiative, Speed) followed by a new Conditions section, Actions, and descriptive traits (Features & Traits). Column 3 holds descriptive and utility sections (Proficiencies, Inventory, Notes, Backstory, Save/Load). This new structure provides a more intuitive flow, starting with key identity and vitals, then grouping related mechanics and finally, utility and descriptive information. -->
    <!-- Visualization & Content Choices: The source report (a guide for a spreadsheet) is translated into an interactive form. Goal: Inform/Organize -> Presentation: HTML forms with inputs and labels. Interaction: Direct user input in text/number fields and checkboxes triggers real-time calculations via vanilla JavaScript. The application now supports expertise, which doubles the proficiency bonus, further enhancing its utility. The new Actions section allows users to add and manage custom attacks, with the "To Hit" bonus calculated dynamically based on a selected ability score and a proficiency checkbox. A new Notes section has been added for general character information. A new Inventory section with currency and attunement fields has been added. The actions section now also includes a dropdown to specify the action type (Action, Bonus Action, Reaction). A new Backstory section has been added for narrative text. A new button and dynamic fields have been added to the Skills section to allow for homebrew skills. All new fields are included in the JSON save/load process. A new Conditions section has been added with a dropdown for standard D&D conditions and a description field that updates automatically. Finally, a Save & Load section has been implemented, offering a one-way PDF export and a robust, two-way JSON export/import for true data persistence. Disadvantage checkboxes have been added to all skills. All combat stats (AC, Initiative, Speed) are now editable. The attunement limit is now an editable field, allowing for a dynamic maximum count. Justification: This is the most direct and effective way to create a functional character sheet. It avoids unnecessary complexity from visualization libraries like Chart.js, focusing instead on utility and clarity. The core value is the automatic calculation of modifiers and bonuses, which JS handles perfectly. The addition of JSON import/export provides a practical solution for data persistence that is not feasible with a PDF. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F5F5F4; /* stone-100 */
        }
        h1, h2, h3 {
            font-family: 'Mate', serif;
        }
        .stat-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            height: fit-content;
        }
        .stat-block {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .stat-block:hover {
            background-color: #FAFAF9; /* stone-50 */
        }
        .stat-label {
            font-weight: 500;
            color: #44403C; /* stone-700 */
        }
        .ability-score-input {
            width: 4rem;
            text-align: center;
            border: 1px solid #D6D3D1; /* stone-300 */
            border-radius: 0.375rem;
            padding: 0.25rem;
        }
        .modifier-display {
            font-size: 1.25rem;
            font-weight: 600;
            color: #A855F7; /* purple-500 */
            width: 3rem;
            text-align: center;
        }
        .skill-modifier-display {
            font-weight: 600;
            color: #166534; /* green-800 */
            width: 2.5rem;
            text-align: right;
        }
        input[type="checkbox"] {
            width: 1.25rem;
            height: 1.25rem;
            accent-color: #A855F7; /* purple-500 */
        }
        .header-input {
            background-color: transparent;
            border: none;
            border-bottom: 2px solid #D6D3D1; /* stone-300 */
            width: 100%;
            padding: 0.25rem 0.1rem;
            font-size: 1rem;
            font-weight: 500;
        }
        .header-input:focus {
            outline: none;
            border-bottom-color: #A855F7; /* purple-500 */
        }
        .combat-stat-box {
            background-color: #FAFAF9; /* stone-50 */
            border: 1px solid #E7E5E4; /* stone-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            text-align: center;
        }
        .combat-stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #262626; /* neutral-800 */
        }
        .combat-stat-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #78716C; /* stone-500 */
            margin-top: 0.25rem;
        }
        .action-row {
            border-bottom: 1px dashed #D6D3D1;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
        .action-row:last-child {
            border-bottom: none;
        }
        .currency-input {
            width: 100%;
            text-align: center;
            border: 1px solid #D6D3D1;
            border-radius: 0.375rem;
            padding: 0.25rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        .condition-block {
            border-bottom: 1px dashed #D6D3D1;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-stone-800">D&D 5e Character Sheet</h1>
            <p class="text-stone-600 mt-2">An interactive sheet to manage your character's statistics and abilities.</p>
        </header>
        
        <!-- TOP SECTION: CHARACTER DETAILS & HP -->
        <div class="stat-card mb-6">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div class="sm:col-span-3">
                    <label for="characterName" class="text-sm font-medium text-stone-500">Character Name</label>
                    <input type="text" id="characterName" class="header-input text-2xl" placeholder="Lancelot">
                </div>
                <div>
                    <label for="classLevel" class="text-sm font-medium text-stone-500">Class & Level</label>
                    <input type="text" id="classLevel" class="header-input" placeholder="Paladin 5">
                </div>
                <div>
                    <label for="background" class="text-sm font-medium text-stone-500">Background</label>
                    <input type="text" id="background" class="header-input" placeholder="Noble">
                </div>
                <div>
                    <label for="playerName" class="text-sm font-medium text-stone-500">Player Name</label>
                    <input type="text" id="playerName" class="header-input" placeholder="Arthur">
                </div>
                <div>
                    <label for="race" class="text-sm font-medium text-stone-500">Race</label>
                    <input type="text" id="race" class="header-input" placeholder="Human">
                </div>
                <div>
                    <label for="alignment" class="text-sm font-medium text-stone-500">Alignment</label>
                    <input type="text" id="alignment" class="header-input" placeholder="Lawful Good">
                </div>
                <div>
                    <label for="experience" class="text-sm font-medium text-stone-500">Experience Points</label>
                    <input type="number" id="experience" class="header-input" placeholder="6500">
                </div>
            </div>
             <div class="stat-card border border-stone-200 p-4 mt-6">
                <label class="text-sm font-medium text-stone-500">Hit Points</label>
                <div class="flex items-center justify-center gap-2 mt-2">
                     <input type="number" id="currentHP" class="w-full text-center text-xl p-2 border border-stone-300 rounded" placeholder="HP">
                     <span class="text-stone-500">/</span>
                     <input type="number" id="maxHP" class="w-full text-center text-xl p-2 border border-stone-300 rounded" placeholder="Max">
                </div>
            </div>
        </div>

        <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- COLUMN 1: CORE STATS -->
            <div class="flex flex-col gap-6">
                <!-- ABILITY SCORES -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 mb-4 text-center">Ability Scores</h2>
                    <div id="ability-scores-container"></div>
                </div>

                <!-- SAVING THROWS -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 mb-4 text-center">Saving Throws</h2>
                    <div id="saving-throws-container"></div>
                </div>

                <!-- SKILLS -->
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-stone-800 text-center">Skills</h2>
                        <button id="addSkillBtn" class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">+</button>
                    </div>
                    <div id="skills-container"></div>
                    <div id="homebrew-skills-container"></div>
                </div>
            </div>

            <!-- COLUMN 2: COMBAT -->
            <div class="flex flex-col gap-6">
                <!-- COMBAT STATS (Remaining) -->
                <div class="stat-card">
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="combat-stat-box">
                            <input type="number" id="armorClassDisplay" class="combat-stat-value w-full text-center bg-transparent border-none focus:ring-0" value="10" oninput="updateCharacterSheet()">
                            <div class="combat-stat-label">Armor Class</div>
                        </div>
                        <div class="combat-stat-box">
                            <input type="number" id="initiativeDisplay" class="combat-stat-value w-full text-center bg-transparent border-none focus:ring-0" value="0" oninput="updateCharacterSheet()">
                            <div class="combat-stat-label">Initiative</div>
                        </div>
                        <div class="combat-stat-box">
                            <input type="text" id="speed" class="combat-stat-value w-full text-center bg-transparent border-none focus:ring-0" value="30ft">
                            <div class="combat-stat-label">Speed</div>
                        </div>
                    </div>
                     <div class="grid grid-cols-2 gap-4 mt-4">
                        <div class="stat-card border border-stone-200 p-4">
                            <label class="text-sm font-medium text-stone-500">Hit Dice</label>
                            <input type="text" id="hitDice" class="w-full text-center text-lg p-1 mt-1 border border-stone-300 rounded" placeholder="e.g. 5d10">
                        </div>
                        <div class="stat-card border border-stone-200 p-4">
                            <label class="text-sm font-medium text-stone-500">Proficiency</label>
                            <input type="number" id="proficiencyBonus" class="w-full text-center text-lg p-1 mt-1 border border-stone-300 rounded" value="2" oninput="updateCharacterSheet()">
                        </div>
                    </div>
                </div>
                
                <!-- CONDITIONS -->
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-stone-800 text-center">Conditions</h2>
                        <button id="addConditionBtn" class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">+</button>
                    </div>
                    <div id="conditions-container" class="flex flex-col gap-4"></div>
                </div>

                <!-- ACTIONS -->
                <div class="stat-card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-stone-800 text-center">Actions</h2>
                        <button id="addActionBtn" class="bg-purple-500 text-white rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">+</button>
                    </div>
                    <div id="actions-container"></div>
                </div>
                
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 mb-4 text-center">Features & Traits</h2>
                    <textarea class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="List your racial traits, class features, feats, etc."></textarea>
                </div>
            </div>

            <!-- COLUMN 3: DESCRIPTIVE & UTILITY -->
            <div class="flex flex-col gap-6">
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 mb-4 text-center">Other Proficiencies & Languages</h2>
                    <textarea class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="List your armor, weapon, and tool proficiencies, as well as languages."></textarea>
                </div>

                <!-- INVENTORY & ATTUNEMENT -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 mb-4 text-center">Inventory & Attunement</h2>
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-stone-600">Attuned Items</h3>
                        <div class="flex items-center gap-2">
                            <span id="attunementCount" class="text-sm font-bold text-stone-500">0/3</span>
                            <button id="addAttunedBtn" class="bg-purple-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-md font-bold">+</button>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-4">
                        <label for="maxAttunement" class="text-sm font-medium text-stone-500">Max Attuned Items</label>
                        <input type="number" id="maxAttunement" class="w-16 p-1 border border-stone-300 rounded-md text-sm text-center" value="3" min="0" oninput="updateAttunementCount()">
                    </div>
                    <div id="attunedItems-container" class="mb-4 flex flex-col gap-2"></div>
                    <h3 class="text-xl font-bold text-stone-600 mb-2">General Items</h3>
                    <div class="grid grid-cols-5 gap-2 mb-4">
                        <div>
                            <label for="cp" class="text-sm font-medium text-stone-500">CP</label>
                            <input type="number" id="cp" class="currency-input" placeholder="0">
                        </div>
                        <div>
                            <label for="sp" class="text-sm font-medium text-stone-500">SP</label>
                            <input type="number" id="sp" class="currency-input" placeholder="0">
                        </div>
                        <div>
                            <label for="ep" class="text-sm font-medium text-stone-500">EP</label>
                            <input type="number" id="ep" class="currency-input" placeholder="0">
                        </div>
                        <div>
                            <label for="gp" class="text-sm font-medium text-stone-500">GP</label>
                            <input type="number" id="gp" class="currency-input" placeholder="0">
                        </div>
                        <div>
                            <label for="pp" class="text-sm font-medium text-stone-500">PP</label>
                            <input type="number" id="pp" class="currency-input" placeholder="0">
                        </div>
                    </div>
                    <textarea id="inventory" class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="List your items here..."></textarea>
                </div>

                <!-- NOTES -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 mb-4 text-center">Notes</h2>
                    <textarea id="notes" class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="Add any important notes, plot points, or reminders here."></textarea>
                </div>

                <!-- BACKSTORY -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 mb-4 text-center">Backstory</h2>
                    <textarea id="backstory" class="w-full h-48 p-2 border border-stone-300 rounded-md" placeholder="Describe your character's history, motivations, and goals."></textarea>
                </div>
                
                <!-- SAVE & LOAD -->
                <div class="stat-card">
                    <h2 class="text-2xl font-bold text-stone-800 mb-4 text-center">Save & Load</h2>
                    <div class="flex flex-col gap-4">
                        <button id="exportPdfBtn" class="w-full bg-purple-500 text-white font-bold py-2 px-4 rounded-lg">Export as PDF</button>
                        <button id="exportJsonBtn" class="w-full bg-stone-700 text-white font-bold py-2 px-4 rounded-lg">Export as JSON</button>
                        <input type="file" id="importJsonInput" class="hidden" accept=".json">
                        <button id="importJsonBtn" class="w-full bg-stone-700 text-white font-bold py-2 px-4 rounded-lg">Import from JSON</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const abilities = [
            { name: 'Strength', abbr: 'STR' },
            { name: 'Dexterity', abbr: 'DEX' },
            { name: 'Constitution', abbr: 'CON' },
            { name: 'Intelligence', abbr: 'INT' },
            { name: 'Wisdom', abbr: 'WIS' },
            { name: 'Charisma', abbr: 'CHA' },
        ];

        const skills = [
            { name: 'Acrobatics', ability: 'DEX' },
            { name: 'Animal Handling', ability: 'WIS' },
            { name: 'Arcana', ability: 'INT' },
            { name: 'Athletics', ability: 'STR' },
            { name: 'Deception', ability: 'CHA' },
            { name: 'History', ability: 'INT' },
            { name: 'Insight', ability: 'WIS' },
            { name: 'Intimidation', ability: 'CHA' },
            { name: 'Investigation', ability: 'INT' },
            { name: 'Medicine', ability: 'WIS' },
            { name: 'Nature', ability: 'INT' },
            { name: 'Perception', ability: 'WIS' },
            { name: 'Performance', ability: 'CHA' },
            { name: 'Persuasion', ability: 'CHA' },
            { name: 'Religion', ability: 'INT' },
            { name: 'Sleight of Hand', ability: 'DEX' },
            { name: 'Stealth', ability: 'DEX' },
            { name: 'Survival', ability: 'WIS' },
        ];
        
        const conditions = {
            'Blinded': 'You cannot see and automatically fail ability checks that require sight. Attack rolls against you have advantage, and your attack rolls have disadvantage.',
            'Charmed': 'You are charmed. You can\'t attack the charmer or target them with harmful abilities or magical effects. The charmer has advantage on ability checks to interact socially with you.',
            'Deafened': 'You cannot hear and automatically fail any ability checks that require hearing.',
            'Frightened': 'You have disadvantage on ability checks and attack rolls while the source of your fear is within line of sight. You can\'t willingly move closer to the source of your fear.',
            'Grappled': 'Your speed becomes 0, and you cannot benefit from any bonus to your speed. The condition ends if the grappler is incapacitated or if you are removed from the grappler\'s reach.',
            'Incapacitated': 'You can\'t take actions or reactions.',
            'Invisible': 'You are impossible to see without the aid of magic or a special sense. For the purpose of hiding, you are heavily obscured. Attack rolls against you have disadvantage, and your attack rolls have advantage.',
            'Paralyzed': 'You are incapacitated and can\'t move or speak. You automatically fail Strength and Dexterity saving throws. Attack rolls against you have advantage. Any attack that hits you is a critical hit if the attacker is within 5 feet of you.',
            'Petrified': 'You are transformed into a solid inanimate substance. You are incapacitated and can\'t move or speak. You automatically fail Strength and Dexterity saving throws. Attack rolls against you have advantage. You have resistance to all damage. You are immune to poison and disease.',
            'Poisoned': 'You have disadvantage on attack rolls and ability checks.',
            'Prone': 'Your only movement option is to crawl, unless you get up and use half your speed to do so. You have disadvantage on attack rolls. Attack rolls against you have advantage if the attacker is within 5 feet, otherwise they have disadvantage.',
            'Restrained': 'Your speed becomes 0, and you can\'t benefit from any bonus to your speed. You have disadvantage on attack rolls and Dexterity saving throws. Attack rolls against you have advantage.',
            'Stunned': 'You are incapacitated and can\'t move, and can only speak falteringly. You automatically fail Strength and Dexterity saving throws. Attack rolls against you have advantage.',
            'Unconscious': 'You are incapacitated, can\'t move or speak, and are unaware of your surroundings. You drop whatever you are holding and fall prone. You automatically fail Strength and Dexterity saving throws. Attack rolls against you have advantage. Any attack that hits you is a critical hit if the attacker is within 5 feet of you.'
        };
        
        function createStatBlock(container, id, label) {
            const block = document.createElement('div');
            block.className = 'stat-block';
            block.innerHTML = `
                <label for="${id}" class="stat-label">${label}</label>
                <div class="flex items-center gap-2">
                    <input type="number" id="${id}" class="ability-score-input" value="10" oninput="updateCharacterSheet()">
                    <div id="${id}Mod" class="modifier-display">+0</div>
                </div>
            `;
            container.appendChild(block);
        }

        function createSavingThrowBlock(container, id, label, abilityId) {
            const block = document.createElement('div');
            block.className = 'stat-block';
            block.innerHTML = `
                <div class="flex items-center gap-3">
                    <input type="checkbox" id="${id}Prof" onchange="updateCharacterSheet()">
                    <label for="${id}Prof" class="stat-label">${label}</label>
                </div>
                <div id="${id}Bonus" class="skill-modifier-display">+0</div>
            `;
            container.appendChild(block);
        }

        function createSkillBlock(container, skill) {
            const id = skill.name.replace(/\s+/g, '');
            const block = document.createElement('div');
            block.className = 'stat-block';
            block.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-stone-500">P</span>
                    <input type="checkbox" id="${id}Prof" onchange="updateCharacterSheet()">
                    <span class="text-sm font-bold text-stone-500 ml-2">E</span>
                    <input type="checkbox" id="${id}Expertise" onchange="updateCharacterSheet()">
                    <span class="text-sm font-bold text-stone-500 ml-2">D</span>
                    <input type="checkbox" id="${id}Disadvantage" onchange="updateCharacterSheet()">
                    <label for="${id}Prof" class="stat-label ml-2">${skill.name} <span class="text-xs text-stone-400">(${skill.ability})</span></label>
                </div>
                <div id="${id}Bonus" class="skill-modifier-display">+0</div>
            `;
            container.appendChild(block);
        }
        
        function createHomebrewSkillBlock(container, data = {}) {
            const skillId = data.id || `homebrew-skill-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const block = document.createElement('div');
            block.className = 'stat-block homebrew-skill';
            block.id = skillId;
            block.innerHTML = `
                <div class="flex items-center gap-2 flex-grow">
                    <div class="flex items-center gap-2">
                        <span class="text-sm font-bold text-stone-500">P</span>
                        <input type="checkbox" id="${skillId}-prof" onchange="updateCharacterSheet()" ${data.proficient ? 'checked' : ''}>
                        <span class="text-sm font-bold text-stone-500 ml-2">E</span>
                        <input type="checkbox" id="${skillId}-expertise" onchange="updateCharacterSheet()" ${data.expertise ? 'checked' : ''}>
                        <span class="text-sm font-bold text-stone-500 ml-2">D</span>
                        <input type="checkbox" id="${skillId}-disadvantage" onchange="updateCharacterSheet()" ${data.disadvantage ? 'checked' : ''}>
                    </div>
                    <input type="text" id="${skillId}-name" class="w-2/3 p-1 border border-stone-300 rounded-md text-sm" placeholder="Skill Name" value="${data.name || ''}" oninput="updateCharacterSheet()">
                    <select id="${skillId}-ability" class="w-1/3 p-1 border border-stone-300 rounded-md text-sm" onchange="updateCharacterSheet()">
                        ${abilities.map(ability => `<option value="${ability.abbr}" ${data.ability === ability.abbr ? 'selected' : ''}>${ability.abbr}</option>`).join('')}
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <div id="${skillId}-bonus" class="skill-modifier-display">+0</div>
                    <button onclick="document.getElementById('${skillId}').remove(); updateCharacterSheet();" class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">&times;</button>
                </div>
            `;
            container.appendChild(block);
            updateCharacterSheet();
        }

        function createActionBlock(container, data = {}) {
            const actionId = data.id || `action-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const actionRow = document.createElement('div');
            actionRow.className = 'action-row grid grid-cols-1 md:grid-cols-3 gap-4';
            actionRow.id = actionId;
            actionRow.innerHTML = `
                <div class="col-span-1 md:col-span-3">
                    <label for="${actionId}-name" class="text-sm font-medium text-stone-500">Action Name</label>
                    <input type="text" id="${actionId}-name" class="header-input" value="${data.name || ''}" placeholder="e.g., Longsword Attack">
                </div>
                <div class="flex flex-col">
                    <label for="${actionId}-type" class="text-sm font-medium text-stone-500">Type</label>
                    <select id="${actionId}-type" class="w-full p-2 border border-stone-300 rounded-md mb-2" onchange="updateCharacterSheet()">
                        <option value="Action" ${data.type === 'Action' ? 'selected' : ''}>Action</option>
                        <option value="Bonus Action" ${data.type === 'Bonus Action' ? 'selected' : ''}>Bonus Action</option>
                        <option value="Reaction" ${data.type === 'Reaction' ? 'selected' : ''}>Reaction</option>
                    </select>
                    <label for="${actionId}-stat" class="text-sm font-medium text-stone-500">To Hit</label>
                    <div class="flex items-center gap-2">
                         <span class="text-sm font-bold text-stone-500">P</span>
                         <input type="checkbox" id="${actionId}-prof" onchange="updateCharacterSheet()" ${data.proficient ? 'checked' : ''}>
                        <select id="${actionId}-stat" class="w-full p-2 border border-stone-300 rounded-md" onchange="updateCharacterSheet()">
                            ${abilities.map(ability => `<option value="${ability.abbr}" ${data.stat === ability.abbr ? 'selected' : ''}>${ability.abbr}</option>`).join('')}
                        </select>
                        <div id="${actionId}-tohit" class="modifier-display w-12">+0</div>
                    </div>
                </div>
                <div>
                    <label for="${actionId}-damage" class="text-sm font-medium text-stone-500">Damage</label>
                    <input type="text" id="${actionId}-damage" class="w-full p-2 border border-stone-300 rounded-md" value="${data.damage || ''}" placeholder="e.g., 1d8+3 Slashing">
                </div>
                <div class="flex items-center justify-end">
                    <button onclick="document.getElementById('${actionId}').remove(); updateCharacterSheet();" class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold -mt-8">&times;</button>
                </div>
            `;
            container.appendChild(actionRow);
            updateCharacterSheet();
        }

        function createAttunedItemBlock(container, data = '') {
            const maxAttunement = parseInt(document.getElementById('maxAttunement').value) || 0;
            if (container.children.length >= maxAttunement) {
                alert(`You can only have up to ${maxAttunement} attuned items.`);
                return;
            }
            const itemId = `attuned-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const itemRow = document.createElement('div');
            itemRow.className = 'flex items-center gap-2';
            itemRow.id = itemId;
            itemRow.innerHTML = `
                <input type="text" class="w-full p-2 border border-stone-300 rounded-md text-sm" value="${data}" placeholder="Item Name">
                <button onclick="document.getElementById('${itemId}').remove(); updateAttunementCount();" class="bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">&times;</button>
            `;
            container.appendChild(itemRow);
            updateAttunementCount();
        }
        
        function createConditionBlock(container, data = {}) {
            const conditionId = data.id || `condition-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const block = document.createElement('div');
            block.className = 'condition-block';
            block.id = conditionId;
            block.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <select id="${conditionId}-select" class="w-2/3 p-2 border border-stone-300 rounded-md" onchange="updateConditionDescription('${conditionId}')">
                        <option value="">-- Select a Condition --</option>
                        ${Object.keys(conditions).map(condition => `<option value="${condition}" ${data.name === condition ? 'selected' : ''}>${condition}</option>`).join('')}
                    </select>
                    <button onclick="document.getElementById('${conditionId}').remove();" class="bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold">&times;</button>
                </div>
                <p id="${conditionId}-description" class="text-sm text-stone-600 italic px-2">${data.description || ''}</p>
            `;
            container.appendChild(block);
            if (data.name) {
                updateConditionDescription(conditionId);
            }
        }


        function updateActionToHit(actionId, abilityMods, proficiencyBonus) {
            const statSelect = document.getElementById(`${actionId}-stat`);
            const profCheckbox = document.getElementById(`${actionId}-prof`);
            const toHitDisplay = document.getElementById(`${actionId}-tohit`);

            if (statSelect && toHitDisplay) {
                const selectedStat = statSelect.value;
                const statMod = abilityMods[selectedStat] || 0;
                const isProficient = profCheckbox.checked;
                const bonus = statMod + (isProficient ? proficiencyBonus : 0);
                toHitDisplay.textContent = formatBonus(bonus);
            }
        }

        function updateAttunementCount() {
            const count = document.getElementById('attunedItems-container').children.length;
            const maxAttunement = document.getElementById('maxAttunement').value || 3;
            document.getElementById('attunementCount').textContent = `${count}/${maxAttunement}`;
        }
        
        function updateConditionDescription(conditionId) {
            const selectElement = document.getElementById(`${conditionId}-select`);
            const descriptionElement = document.getElementById(`${conditionId}-description`);
            const selectedCondition = selectElement.value;
            
            if (conditions[selectedCondition]) {
                descriptionElement.textContent = conditions[selectedCondition];
            } else {
                descriptionElement.textContent = '';
            }
        }

        function initializeSheet() {
            const abilityContainer = document.getElementById('ability-scores-container');
            abilities.forEach(ability => createStatBlock(abilityContainer, ability.abbr.toLowerCase(), ability.name));

            const savingThrowsContainer = document.getElementById('saving-throws-container');
            abilities.forEach(ability => createSavingThrowBlock(savingThrowsContainer, ability.abbr.toLowerCase() + 'Save', ability.name, ability.abbr.toLowerCase()));
            
            const skillsContainer = document.getElementById('skills-container');
            skills.forEach(skill => createSkillBlock(skillsContainer, skill));
            
            document.getElementById('addActionBtn').addEventListener('click', () => {
                createActionBlock(document.getElementById('actions-container'));
            });

            document.getElementById('addAttunedBtn').addEventListener('click', () => {
                createAttunedItemBlock(document.getElementById('attunedItems-container'));
            });

            document.getElementById('addSkillBtn').addEventListener('click', () => {
                createHomebrewSkillBlock(document.getElementById('homebrew-skills-container'));
            });
            
            document.getElementById('addConditionBtn').addEventListener('click', () => {
                createConditionBlock(document.getElementById('conditions-container'));
            });

            document.getElementById('exportPdfBtn').addEventListener('click', exportToPdf);
            document.getElementById('exportJsonBtn').addEventListener('click', exportToJson);
            document.getElementById('importJsonBtn').addEventListener('click', () => {
                document.getElementById('importJsonInput').click();
            });
            document.getElementById('importJsonInput').addEventListener('change', importFromJson);
            
            updateCharacterSheet();
        }

        function getModifier(score) {
            return Math.floor((score - 10) / 2);
        }

        function formatBonus(bonus) {
            return bonus >= 0 ? `+${bonus}` : bonus;
        }

        function updateCharacterSheet() {
            const proficiencyBonus = parseInt(document.getElementById('proficiencyBonus').value) || 0;
            const abilityScores = {};
            const abilityMods = {};

            abilities.forEach(ability => {
                const abbr = ability.abbr.toLowerCase();
                const score = parseInt(document.getElementById(abbr).value) || 10;
                const mod = getModifier(score);
                abilityScores[ability.abbr] = score;
                abilityMods[ability.abbr] = mod;
                document.getElementById(`${abbr}Mod`).textContent = formatBonus(mod);
            });

            abilities.forEach(ability => {
                const abbr = ability.abbr.toLowerCase();
                const isProficient = document.getElementById(`${abbr}SaveProf`).checked;
                const bonus = abilityMods[ability.abbr] + (isProficient ? proficiencyBonus : 0);
                document.getElementById(`${abbr}SaveBonus`).textContent = formatBonus(bonus);
            });

            skills.forEach(skill => {
                const id = skill.name.replace(/\s+/g, '');
                const isExpert = document.getElementById(`${id}Expertise`).checked;
                const isProficient = document.getElementById(`${id}Prof`).checked;
                const isDisadvantage = document.getElementById(`${id}Disadvantage`).checked;
                let bonus = abilityMods[skill.ability] + (isExpert ? proficiencyBonus * 2 : (isProficient ? proficiencyBonus : 0));
                
                // Disadvantage logic (not affecting the modifier directly, but a status to show)
                const bonusDisplay = document.getElementById(`${id}Bonus`);
                if(isDisadvantage){
                    bonusDisplay.style.color = '#B91C1C'; // Red
                } else {
                    bonusDisplay.style.color = '#166534'; // Green
                }
                
                document.getElementById(`${id}Bonus`).textContent = formatBonus(bonus);
            });

            document.querySelectorAll('.homebrew-skill').forEach(skillElement => {
                const id = skillElement.id;
                const ability = document.getElementById(`${id}-ability`).value;
                const isExpert = document.getElementById(`${id}-expertise`).checked;
                const isProficient = document.getElementById(`${id}-prof`).checked;
                const isDisadvantage = document.getElementById(`${id}-disadvantage`).checked;
                let bonus = abilityMods[ability] + (isExpert ? proficiencyBonus * 2 : (isProficient ? proficiencyBonus : 0));

                const bonusDisplay = document.getElementById(`${id}-bonus`);
                 if(isDisadvantage){
                    bonusDisplay.style.color = '#B91C1C'; // Red
                } else {
                    bonusDisplay.style.color = '#166534'; // Green
                }
                document.getElementById(`${id}-bonus`).textContent = formatBonus(bonus);
            });
            
            document.querySelectorAll('.action-row').forEach(row => {
                updateActionToHit(row.id, abilityMods, proficiencyBonus);
            });

            updateAttunementCount();
        }
        
        async function exportToPdf() {
            const mainContent = document.querySelector('main');
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            const canvas = await html2canvas(mainContent, { scale: 2 });
            const imgData = canvas.toDataURL('image/png');
            const imgProps = doc.getImageProperties(imgData);
            const pdfWidth = doc.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

            doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            doc.save('dnd-character-sheet.pdf');
        }

        function exportToJson() {
            const data = {
                characterInfo: {
                    characterName: document.getElementById('characterName').value,
                    classLevel: document.getElementById('classLevel').value,
                    background: document.getElementById('background').value,
                    playerName: document.getElementById('playerName').value,
                    race: document.getElementById('race').value,
                    alignment: document.getElementById('alignment').value,
                    experience: document.getElementById('experience').value,
                },
                combatStats: {
                    ac: document.getElementById('armorClassDisplay').value,
                    speed: document.getElementById('speed').value,
                    initiative: document.getElementById('initiativeDisplay').value,
                    currentHP: document.getElementById('currentHP').value,
                    maxHP: document.getElementById('maxHP').value,
                    hitDice: document.getElementById('hitDice').value,
                    proficiencyBonus: document.getElementById('proficiencyBonus').value,
                },
                abilityScores: {},
                savingThrows: {},
                skills: {},
                homebrewSkills: [],
                conditions: [],
                actions: [],
                notes: document.getElementById('notes').value,
                backstory: document.getElementById('backstory').value,
                inventory: document.getElementById('inventory').value,
                attunedItems: {
                    maxAttunement: document.getElementById('maxAttunement').value,
                    items: Array.from(document.querySelectorAll('#attunedItems-container input[type="text"]')).map(input => input.value),
                },
                currency: {
                    cp: document.getElementById('cp').value,
                    sp: document.getElementById('sp').value,
                    ep: document.getElementById('ep').value,
                    gp: document.getElementById('gp').value,
                    pp: document.getElementById('pp').value,
                }
            };

            abilities.forEach(ability => {
                const abbr = ability.abbr.toLowerCase();
                data.abilityScores[abbr] = parseInt(document.getElementById(abbr).value);
                data.savingThrows[`${abbr}SaveProf`] = document.getElementById(`${abbr}SaveProf`).checked;
            });

            skills.forEach(skill => {
                const id = skill.name.replace(/\s+/g, '');
                data.skills[id] = {
                    proficient: document.getElementById(`${id}Prof`).checked,
                    expertise: document.getElementById(`${id}Expertise`).checked,
                    disadvantage: document.getElementById(`${id}Disadvantage`).checked,
                };
            });
            
            document.querySelectorAll('.homebrew-skill').forEach(skillElement => {
                const id = skillElement.id;
                data.homebrewSkills.push({
                    id: id,
                    name: document.getElementById(`${id}-name`).value,
                    ability: document.getElementById(`${id}-ability`).value,
                    proficient: document.getElementById(`${id}-prof`).checked,
                    expertise: document.getElementById(`${id}-expertise`).checked,
                    disadvantage: document.getElementById(`${id}-disadvantage`).checked,
                });
            });
            
            document.querySelectorAll('.condition-block').forEach(conditionElement => {
                const id = conditionElement.id;
                data.conditions.push({
                    id: id,
                    name: document.getElementById(`${id}-select`).value
                });
            });

            document.querySelectorAll('.action-row').forEach(row => {
                data.actions.push({
                    id: row.id,
                    name: document.getElementById(`${row.id}-name`).value,
                    type: document.getElementById(`${row.id}-type`).value,
                    stat: document.getElementById(`${row.id}-stat`).value,
                    proficient: document.getElementById(`${row.id}-prof`).checked,
                    damage: document.getElementById(`${row.id}-damage`).value,
                });
            });

            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.characterInfo.characterName || 'dnd-character'}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importFromJson(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    document.getElementById('characterName').value = data.characterInfo.characterName;
                    document.getElementById('classLevel').value = data.characterInfo.classLevel;
                    document.getElementById('background').value = data.characterInfo.background;
                    document.getElementById('playerName').value = data.characterInfo.playerName;
                    document.getElementById('race').value = data.characterInfo.race;
                    document.getElementById('alignment').value = data.characterInfo.alignment;
                    document.getElementById('experience').value = data.characterInfo.experience;
                    
                    document.getElementById('armorClassDisplay').value = data.combatStats.ac;
                    document.getElementById('speed').value = data.combatStats.speed;
                    document.getElementById('initiativeDisplay').value = data.combatStats.initiative;
                    document.getElementById('currentHP').value = data.combatStats.currentHP;
                    document.getElementById('maxHP').value = data.combatStats.maxHP;
                    document.getElementById('hitDice').value = data.combatStats.hitDice;
                    document.getElementById('proficiencyBonus').value = data.combatStats.proficiencyBonus;

                    abilities.forEach(ability => {
                        const abbr = ability.abbr.toLowerCase();
                        document.getElementById(abbr).value = data.abilityScores[abbr] || 10;
                        document.getElementById(`${abbr}SaveProf`).checked = data.savingThrows[`${abbr}SaveProf`] || false;
                    });

                    skills.forEach(skill => {
                        const id = skill.name.replace(/\s+/g, '');
                        if (data.skills[id]) {
                            document.getElementById(`${id}Prof`).checked = data.skills[id].proficient;
                            document.getElementById(`${id}Expertise`).checked = data.skills[id].expertise;
                            document.getElementById(`${id}Disadvantage`).checked = data.skills[id].disadvantage;
                        }
                    });

                    document.getElementById('inventory').value = data.inventory || '';
                    document.getElementById('cp').value = data.currency.cp;
                    document.getElementById('sp').value = data.currency.sp;
                    document.getElementById('ep').value = data.currency.ep;
                    document.getElementById('gp').value = data.currency.gp;
                    document.getElementById('pp').value = data.currency.pp;

                    document.getElementById('notes').value = data.notes;
                    document.getElementById('backstory').value = data.backstory;

                    const actionsContainer = document.getElementById('actions-container');
                    actionsContainer.innerHTML = '';
                    if (data.actions && Array.isArray(data.actions)) {
                        data.actions.forEach(actionData => createActionBlock(actionsContainer, actionData));
                    }

                    const attunedItemsContainer = document.getElementById('attunedItems-container');
                    attunedItemsContainer.innerHTML = '';
                    if (data.attunedItems && Array.isArray(data.attunedItems.items)) {
                        document.getElementById('maxAttunement').value = data.attunedItems.maxAttunement;
                        data.attunedItems.items.forEach(item => createAttunedItemBlock(attunedItemsContainer, item));
                    }

                    const homebrewSkillsContainer = document.getElementById('homebrew-skills-container');
                    homebrewSkillsContainer.innerHTML = '';
                    if (data.homebrewSkills && Array.isArray(data.homebrewSkills)) {
                        data.homebrewSkills.forEach(skillData => createHomebrewSkillBlock(homebrewSkillsContainer, skillData));
                    }
                    
                    const conditionsContainer = document.getElementById('conditions-container');
                    conditionsContainer.innerHTML = '';
                    if (data.conditions && Array.isArray(data.conditions)) {
                        data.conditions.forEach(conditionData => createConditionBlock(conditionsContainer, conditionData));
                    }

                    updateCharacterSheet();
                    alert('Character data imported successfully!');
                } catch (error) {
                    alert('Failed to import file. Please ensure it is a valid JSON file.');
                }
            };
            reader.readAsText(file);
        }

        document.addEventListener('DOMContentLoaded', initializeSheet);
    </script>
</body>
</html>
